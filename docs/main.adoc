= Celestial
Ronen Narkis, <narkisr@gmail.com> v0.11.0
:toc: left
:!numbered:
:idseparator: -
:idprefix:
:source-highlighter: pygments
:pygments-style: friendly
:sectlinks:
:ubuntuversion: 14.x
:redisversion: 2.6.13
:celestialversion: 0.11.0
:javaversion: 1.7.x
:imagesdir: docs/img

== Introduction 

Celestial is a server that enables to manage machines life cycle from initial VM creation to deployment automation and user access control,

== Setup

Celestial was designed with deployment simplicity in mind, only two services are required to run Celestial itself and a [Redis](http://redis.io/) instance,

Perquisites:

*   Ubuntu {ubuntuversion}
*   Java {javaversion}
*   Redis >= {redisversion} and up

The following options are available to get started quickly:

* Use Celestial install script.
* Setup a local vagrant machine.

There are a couple of options to get Celestial going, using a dedicate Ubuntu VM and the install script is the recommended production option.

=== Install script

The following install script sets up a clean celestial installation on an Ubuntu server (ubuntuversion) instance:

```bash
$ wget https://gist.githubusercontent.com/narkisr/ad24502f7a4035391692/raw/celestial-install.sh 
$ sudo ./celestial-install.sh
```

Once its done running you have a celestial instance ready and running now:

* Point your browser to https://{hostname}:8443/ (admin/changeme)
* Head on to <<Walkthrough>> section.


=== Vagrant

If you don't have an Ubuntu machine then using Vagrant is an excellent option to test Celestial quickly (make sure to have link:http://opskeleton.github.io/opskeleton/latest/#installation[opskeleton] perquisites installed):

```bash
$ git clone git://github.com/opskeleton/celestial-sandbox.git
$ ./boot.sh
```

Once its done running you have a celestial instance ready and running now:

* Point your browser to https://{hostname}:8443/ (admin/changeme)
* Head on to <<Walkthrough>> section.



== Walkthrough

In this section we will setup AWS integration and create a Redis based machine, we use AWS mainly because its a publicly available API that any one can play with see <<Hypervisors>> for other supported options.

Note that if you didn't install Celestial yet then head on to [installation](/posts/installation.html) first.

Edit the hypervisor section and add the following to /etc/celestial/celestial.edn:

```clojure
:hypervisor {
  :dev {
    :aws {
	:access-key ""
	:secret-key ""
      :ostemplates {           
        :ubuntu-13.04 {:ami "ami-02b55375" :flavor :debian} 
      }
    }
  }
 } 
```

Now we will generate an ssh key on the Celestial machine, this key will be used by Celestial to access the machine via ssh:

```bash
$ ssh-keygen 
```

Configure the private key in /etc/celestial/celestial.edn (match the user to your machine):

```bash
:ssh {
  :private-key-path "/home/{user}/.ssh/id_rsa"
} 
```

Import this key into the list of keypairs in AWS (under the key pairs section) and name it celestial-demo.


We will now use the Web UI to create our first Redis based system hosted on AWS:

*   First we will add a Redis type by heading to Types > Add a Type (or https://{hostname}:8443/#/type/add/), login using admin/changeme).
*   Note that the source url is http://dl.bintray.com/content/narkisr/boxes/redis-sandbox-0.3.5.tar.gz
*   Fill up the rest of the values as in the following image:

image:walkthrough/redis-type-add.png[Linux,85%,85%]


Now head on to Systems > Add a System (or https://{hostname}:8443/#/system/add/) and add a new system (omitted values can be left empty):

image:walkthrough/system-add.png[Part1,85%,85%]

Rest of the form:

image:walkthrough/system-add-cont.png[Part2,85%,85%]

=== Launching the instance

Notice that we didn't choose an operation to be done on system save on the last screen (just for the sake of reviewing functionlity), so we will do it using operations menu. Select the stage operation from the menu:

image:walkthrough/stage-launch.png[Launch,85%,85%]

Once the job has been launched you can follow its status by heading to https://{hostname}:8443/#/jobs:

image:walkthrough/job-running.png[Running,85%,85%]


A successful job will result with:

image:walkthrough/job-done-success.png[Running,85%,85%]

You can also review the run progress in the log file (/var/log/celestial.log), you can ssh into the instance and see Redis is running (using the key you provided).

=== Where to go next

Celestial integrated with many other tools and components, you can set it up to:

*   Start to manage other hypervisors <<Proxmox>> , <<Openstack>>, <<Docker>>.
*   Register hosts atomically in DNS using link:http://www.thekelleys.org.uk/dnsmasq/doc.html[dnsmasq] <<hooks>>.
*   Publish Celestial logs into a central logging system (graylog2/kibana) for auditing the history of your infrastructure changes and track logical workflow <<Transactions>>.
*   Give access to other users and group within your organization to automatically provisioned machines, you can set quotas and limit which environment each user can access.
*   Use the Restful API and automate nightly build machines, use the Swagger UI to move quickly and learn what can be done.



=== Hypervisors

==== EC2


